name: "Gito: AI Code Review"

on:
  pull_request:
    types: [ opened, synchronize, reopened ]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull Request number"
        required: false          # æ”¹ä¸ºéå¿…å¡«ï¼Œä»¥æ”¯æŒçº¯ä»£ç å®¡æŸ¥æ¨¡å¼
      comment:
        description: "Leave a review comment on the PR"
        type: boolean
        default: true

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0            # è·å–å®Œæ•´å†å²ï¼Œä»¥ä¾¿æ¯”è¾ƒåˆ†æ”¯

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install AI Code Review tool
        run: pip install gito.bot~=4.0

      - name: Run AI code analysis
        env:
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_API_TYPE: openai
          OPENAI_BASE_URL: https://api.deepseek.com
          MODEL: "deepseek-chat"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER_FROM_WORKFLOW_DISPATCH: ${{ github.event.inputs.pr_number }}
        run: |
          # åˆ¤æ–­è¿è¡Œæ¨¡å¼
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -z "${{ github.event.inputs.pr_number }}" ]; then
            echo "ğŸŸ¢ Manual run without PR number. Attempting to review changes against default branch..."
            DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"
          
            # å°è¯•å®¡æŸ¥å˜æ›´ï¼ˆdiffï¼‰
            if gito --verbose review --what HEAD --against "origin/${DEFAULT_BRANCH}"; then
              echo "âœ… Changes found and reviewed."
            else
              # å¦‚æœå®¡æŸ¥å¤±è´¥ï¼ˆé€šå¸¸æ˜¯å› ä¸ºæ— å˜æ›´ï¼‰ï¼Œåˆ™å›é€€åˆ°å…¨é‡å®¡æŸ¥
              echo "âš ï¸ No changes found or diff review failed. Falling back to full codebase review..."
              gito --verbose review --all
            fi
          else
            # PR äº‹ä»¶ æˆ– æ‰‹åŠ¨è¿è¡Œä½†æä¾›äº† PR ç¼–å·ï¼šä½¿ç”¨é»˜è®¤ review å‘½ä»¤
            echo "ğŸŸ¢ Running in PR context or with provided PR number."
            gito --verbose review
          fi
          
          # æ¡ä»¶è¯„è®ºé€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.comment }}" == "true" ] && [ -n "${{ github.event.inputs.pr_number }}" ]; then
              gito github-comment --token ${{ secrets.GITHUB_TOKEN }}
            fi
          else
            gito github-comment --token ${{ secrets.GITHUB_TOKEN }}
          fi

      - uses: actions/upload-artifact@v6
        with:
          name: ai-code-review-results
          path: |
            code-review-report.md
            code-review-report.json