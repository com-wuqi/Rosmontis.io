name: "Gito: AI Code Review"

on:
  pull_request:
    types: [ opened, synchronize, reopened ]
  issue_comment:
    types: [ created ]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR ç¼–å· (ä»…åœ¨æ²¡æœ‰ PR å…³è”æ—¶æ‰‹åŠ¨è¾“å…¥)"
        required: false

jobs:
  review:
    if: >
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '/review'))

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install AI Code Review tool
        run: pip install gito.bot~=4.0

      - name: Run AI code review
        env:
          # --- æ ¸å¿ƒé…ç½®ï¼šåŒæ—¶æä¾›å¸¦å‰ç¼€å’Œä¸å¸¦å‰ç¼€çš„å˜é‡ï¼Œç¡®ä¿å·¥å…·èƒ½è®¤å‡ºæ¥ ---
          LLM_API_TYPE: "openai"
          GITO_LLM_TYPE: "openai"

          # ğŸš¨ é‡è¦ï¼šè¯·ç¡®è®¤ä½ åœ¨ GitHub Secrets é‡Œå­˜çš„åå­—åˆ°åº•æ˜¯å“ªä¸€ä¸ªï¼
          # å¦‚æœä½ å­˜çš„æ˜¯ LLM_API_KEYï¼Œå°±ç”¨ ${{ secrets.LLM_API_KEY }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          GITO_LLM_API_KEY: ${{ secrets.LLM_API_KEY }}

          # ä½ çš„è‡ªå®šä¹‰ Base URL å’Œæ¨¡å‹
          LLM_API_BASE: "https://api.deepseek.com/v1"
          GITO_LLM_API_BASE: "https://api.deepseek.com/v1"

          MODEL: "deepseek-reasoner"
          GITO_MODEL: "deepseek-reasoner"

          # --- GitHub ç›¸å…³ ---
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # è‡ªåŠ¨è¯†åˆ« PR ç¼–å·
          PR_NUMBER: ${{ github.event.pull_request.number || github.event.issue.number || github.event.inputs.pr_number }}

        run: |
          # è°ƒè¯•è¯­å¥ï¼šæ£€æŸ¥å˜é‡æ˜¯å¦å­˜åœ¨ï¼ˆä¸ä¼šæ‰“å°å…·ä½“çš„ KEYï¼Œåªä¼šæ˜¾ç¤ºé•¿åº¦ï¼‰
          echo "Checking environment variables..."
          if [ -z "$LLM_API_KEY" ]; then echo "âŒ Error: LLM_API_KEY is empty! Please check GitHub Secrets."; exit 1; fi
          
          # 1. è¿è¡Œå®¡æŸ¥
          gito --verbose review
          
          # 2. ç”Ÿæˆè¿è¡Œæ‘˜è¦ï¼ˆåœ¨ Actions é¡µé¢ç›´æ¥çœ‹ç»“æœï¼‰
          if [ -f code-review-report.md ]; then
            echo "### ğŸ¤– AI Code Review Result" >> $GITHUB_STEP_SUMMARY
            cat code-review-report.md >> $GITHUB_STEP_SUMMARY
          fi

          # 3. åªæœ‰åœ¨ PR ç¯å¢ƒä¸‹æ‰å°è¯•å‘è¯„è®º
          if [ ! -z "$PR_NUMBER" ]; then
            export GITHUB_PR_NUMBER=$PR_NUMBER
            gito github-comment
          else
            echo "No PR number detected. Skipping GitHub comment, review summary is available in Job Summary."
          fi