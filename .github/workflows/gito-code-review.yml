name: "Gito: AI Code Review"

on:
  pull_request:
    types: [ opened, synchronize, reopened ]
  issue_comment:
    types: [ created ]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR 编号 (仅在手动执行且想评论到 PR 时填)"
        required: false

jobs:
  review:
    if: >
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '/review'))

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install AI Code Review tool
        run: pip install gito.bot~=4.0

      - name: Run AI code review
        env:
          # 只需要传这两个最核心的变量，其他的都在 config.toml 里
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}

          # 获取 PR 编号用于评论
          PR_NUMBER: ${{ github.event.pull_request.number || github.event.issue.number || github.event.inputs.pr_number }}
        run: |
          # 运行审查 (Gito 会自动读取 .gito/config.toml)
          gito --verbose review
          
          # 输出摘要到 Actions 页面（无论有没有 PR 都能看）
          if [ -f code-review-report.md ]; then
            echo "### 🤖 AI Code Review Summary" >> $GITHUB_STEP_SUMMARY
            cat code-review-report.md >> $GITHUB_STEP_SUMMARY
          fi

          # 如果有 PR 编号，则发送 GitHub 评论
          if [ ! -z "$PR_NUMBER" ]; then
            export GITHUB_PR_NUMBER=$PR_NUMBER
            gito github-comment
          fi