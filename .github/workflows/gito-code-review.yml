name: "Gito: AI Code Review"

on:
  pull_request:
    types: [ opened, synchronize, reopened ] # 监听 PR 的创建和代码更新
  issue_comment:
    types: [ created ] # 监听评论，从而支持通过评论与 Gito 互动
  workflow_dispatch: # 允许在 GitHub 网页端手动触发

jobs:
  review:
    # 修复后的条件：
    # 1. 允许 pull_request 自动触发
    # 2. 允许 workflow_dispatch 手动触发（注意：单纯手动触发可能因缺失 PR 上下文而失败）
    # 3. 评论触发：必须在 PR 的评论中，且评论内容包含 "/review" 才触发，避免浪费额度
    if: >
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '/review'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Gito AI Code Reviewer
        uses: Nayjest/Gito@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LLM_API_TYPE: "openai"
          LLM_API_KEY: ${{ secrets.CUSTOM_LLM_API_KEY }}
          LLM_API_BASE: "https://api.deepseek.com/v1"
          MODEL: "deepseek-reasoner"