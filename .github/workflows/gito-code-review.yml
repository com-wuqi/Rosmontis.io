name: "Gito: AI Code Review"

on:
  pull_request:
    types: [ opened, synchronize, reopened ]
  issue_comment:
    types: [ created ]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR ç¼–å·ï¼ˆéå¿…å¡«ï¼Œç•™ç©ºåˆ™ä»…ç”Ÿæˆæœ¬åœ°æŠ¥å‘Šï¼‰"
        required: false

jobs:
  review:
    # è§¦å‘æ¡ä»¶ï¼š1. PR æ´»åŠ¨ 2. PR è¯„è®ºåŒ…å« /review 3. æ‰‹åŠ¨ç‚¹å‡»
    if: >
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '/review'))

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install AI Code Review tool
        run: pip install gito.bot~=4.0

      - name: Run AI code review
        id: run_gito
        env:
          # è‡ªå®šä¹‰æ¨¡å‹é…ç½®
          GITO_LLM_TYPE: "openai"
          GITO_LLM_API_KEY: ${{ secrets.CUSTOM_LLM_API_KEY }}
          GITO_LLM_API_BASE: "https://api.deepseek.com/v1" # è®°å¾—æ”¹æˆä½ çš„å®é™…åœ°å€
          GITO_MODEL: "deepseek-reasoner"             # è®°å¾—æ”¹æˆä½ çš„å®é™…æ¨¡å‹å

          # GitHub ç›¸å…³
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # å°è¯•è·å– PR ç¼–å·
          PR_NUMBER: ${{ github.event.pull_request.number || github.event.issue.number || github.event.inputs.pr_number }}
        run: |
          echo "Starting Gito review..."
          # 1. è¿è¡Œæ ¸å¿ƒå®¡æŸ¥ï¼ˆæ— è®ºæœ‰æ²¡æœ‰ PR éƒ½ä¼šç”Ÿæˆ code-review-report.mdï¼‰
          gito --verbose review
          
          # 2. å°†å®¡æŸ¥ç»“æœç›´æ¥è¾“å‡ºåˆ° GitHub Action çš„æ‘˜è¦é¡µé¢ï¼Œæ–¹ä¾¿åœ¨æ²¡æœ‰ PR æ—¶æŸ¥çœ‹
          if [ -f code-review-report.md ]; then
            echo "### ğŸ¤– AI Code Review Summary" >> $GITHUB_STEP_SUMMARY
            cat code-review-report.md >> $GITHUB_STEP_SUMMARY
          fi

          # 3. åªæœ‰åœ¨ PR ç¯å¢ƒä¸‹ï¼Œæ‰å°è¯•å‘é€ GitHub è¯„è®º
          if [ ! -z "$PR_NUMBER" ]; then
            echo "PR detected (ID: $PR_NUMBER), posting comment..."
            # å°† PR ç¼–å·æ˜ å°„ç»™ Gito è¯†åˆ«çš„ç¯å¢ƒå˜é‡
            export GITHUB_PR_NUMBER=$PR_NUMBER
            gito github-comment
          else
            echo "No PR number provided. Skipping GitHub comment."
          fi

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gito-report
          path: |
            code-review-report.md
            code-review-report.json