name: "Gito: AI Code Review"

on:
  pull_request:
    types: [ opened, synchronize, reopened ]
  issue_comment:
    types: [ created ]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR ÁºñÂè∑"
        required: false

jobs:
  review:
    if: >
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '/review'))

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install AI Code Review tool
        run: pip install gito.bot~=4.0

      - name: Run AI code review
        env:
          # Âè™Âú®ËøôÈáåÂºïÁî® SecretÔºåÂÖ∑‰ΩìÁöÑÈÖçÁΩÆÂú®‰∏ãÈù¢ÁöÑ shell ËÑöÊú¨Èáå export
          RAW_API_KEY: ${{ secrets.LLM_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number || github.event.issue.number || github.event.inputs.pr_number }}
        run: |
          # 1. Âº∫Âà∂ËÆæÁΩÆÂπ∂Ê∏ÖÁêÜÁéØÂ¢ÉÂèòÈáèÔºåËß£ÂÜ≥ "openai" ËØÜÂà´ÈîôËØØ
          export LLM_API_TYPE="openai"
          export LLM_API_KEY="$RAW_API_KEY"
          export LLM_API_BASE="https://api.deepseek.com/v1" # ‚¨ÖÔ∏è Á°Æ‰øùËøôÈáåÊúâ /v1
          export MODEL="deepseek-reasoner"             # ‚¨ÖÔ∏è ‰Ω†ÁöÑÊ®°ÂûãÂêç
          
          # 2. È™åËØÅÂèòÈáèÔºà‰ªÖÊâìÂç∞ÂêçÁß∞ÂíåÈïøÂ∫¶ÔºåÁ°Æ‰øùÂÆâÂÖ®Ôºâ
          echo "LLM_API_TYPE is set to: '$LLM_API_TYPE'"
          
          # 3. ÊâßË°åÂÆ°Êü•
          gito --verbose review
          
          # 4. ÁîüÊàê Job Summary
          if [ -f code-review-report.md ]; then
            echo "### ü§ñ AI Code Review Summary" >> $GITHUB_STEP_SUMMARY
            cat code-review-report.md >> $GITHUB_STEP_SUMMARY
          fi

          # 5. Â§ÑÁêÜËØÑËÆ∫
          if [ ! -z "$PR_NUMBER" ]; then
            export GITHUB_PR_NUMBER=$PR_NUMBER
            gito github-comment
          fi