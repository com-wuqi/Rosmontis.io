name: "Gito: AI Code Review"

on:
  pull_request:
    types: [ opened, synchronize, reopened ]
  issue_comment:
    # 允许通过评论触发（例如在 PR 评论 /review）
    types: [ created ]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "手动输入 PR 编号 (仅在手动点击时需要)"
        required: false

jobs:
  review:
    # 过滤条件：1. PR 活动 2. 包含关键字的 PR 评论 3. 手动触发
    if: >
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '/review'))

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install AI Code Review tool
        run: pip install gito.bot~=4.0

      - name: Run AI code review
        env:
          # 1. 核心身份验证
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LLM_API_KEY: ${{ secrets.CUSTOM_LLM_API_KEY }}

          # 2. 自定义模型配置 (你要求的三个关键项)
          LLM_API_TYPE: openai
          LLM_API_BASE: "https://api.deepseek.com/v1" # 在这里填入你的自定义 Base URL
          MODEL: "deepseek-reasoner"             # 在这里填入你的模型名称

          # 3. 动态获取 PR 编号 (解决手动触发不工作的关键)
          GITHUB_PR_NUMBER: >-
            ${{ 
              github.event.pull_request.number || 
              github.event.issue.number || 
              github.event.inputs.pr_number 
            }}
        run: |
          # 运行审查并生成报告
          gito --verbose review
          # 将报告作为评论发布到 GitHub
          gito github-comment

      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gito-code-review-results
          path: |
            code-review-report.md
            code-review-report.json