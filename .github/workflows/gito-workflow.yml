name: "Gito: AI Code Review"

on:
  # PR äº‹ä»¶è‡ªåŠ¨è§¦å‘
  pull_request:
    types: [ opened, synchronize, reopened ]
  # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull Request number (leave empty to review current branch)"
        required: false
      comment:
        description: "Leave a review comment on the PR (only works if pr_number is provided)"
        type: boolean
        default: true

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write   # å…è®¸ç•™ä¸‹ PR è¯„è®º

    steps:
      # æ£€å‡ºä»£ç ï¼Œè·å–å®Œæ•´å†å²ï¼ˆç”¨äºåˆ†æ”¯æ¯”è¾ƒï¼‰
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install Gito
        run: pip install gito.bot~=4.0

      # å…³é”®æ­¥éª¤ï¼šæ¸…ç†å¯èƒ½å¹²æ‰°çš„æœ¬åœ°é…ç½®æ–‡ä»¶
      # å¦‚æœå­˜åœ¨ .gito/config.tomlï¼Œå°†å…¶é‡å‘½åå¤‡ä»½ï¼Œé¿å…è§£æé”™è¯¯
      - name: Backup and ignore local config
        run: |
          if [ -f .gito/config.toml ]; then
            mv .gito/config.toml .gito/config.toml.bak
            echo "âš ï¸ Local config backed up to .gito/config.toml.bak"
          fi

      # è°ƒè¯•ï¼šæ‰“å°å…³é”®ç¯å¢ƒå˜é‡ï¼ˆä¸æ³„éœ²å®Œæ•´å¯†é’¥ï¼‰
      - name: Debug environment variables
        env:
          # åŒé‡è®¾ç½®ç¡®ä¿ OpenAI åº“èƒ½è¯†åˆ«
          OPENAI_API_KEY: ${{ secrets.LLM_API_KEY }}
          OPENAI_BASE_URL: https://api.deepseek.com
          OPENAI_API_BASE: https://api.deepseek.com
          MODEL: deepseek-chat
        run: |
          echo "OPENAI_BASE_URL = $OPENAI_BASE_URL"
          echo "OPENAI_API_BASE = $OPENAI_API_BASE"
          echo "MODEL = $MODEL"
          KEY_PREFIX="${OPENAI_API_KEY:0:5}"
          KEY_SUFFIX="${OPENAI_API_KEY: -5}"
          echo "API Key (prefix/suffix): ${KEY_PREFIX}...${KEY_SUFFIX}"

      # æ ¸å¿ƒä»£ç å®¡æŸ¥æ­¥éª¤
      - name: Run AI code analysis
        env:
          # Gito æ‰€éœ€çš„ç¯å¢ƒå˜é‡
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_API_TYPE: openai
          # åŒæ—¶è®¾ç½®å¤šç§å¯èƒ½çš„ base_url å˜é‡ï¼Œç¡®ä¿è¦†ç›–
          OPENAI_API_KEY: ${{ secrets.LLM_API_KEY }}
          OPENAI_BASE_URL: https://api.deepseek.com
          OPENAI_API_BASE: https://api.deepseek.com
          MODEL: deepseek-chat
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER_FROM_WORKFLOW_DISPATCH: ${{ github.event.inputs.pr_number }}
        run: |
          # åˆ¤æ–­è¿è¡Œæ¨¡å¼
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -z "${{ github.event.inputs.pr_number }}" ]; then
            echo "ğŸŸ¢ Manual run without PR number. Attempting to review changes against default branch..."
            DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"
          
            # ä¸´æ—¶æ–‡ä»¶ç”¨äºæ•è·è¾“å‡º
            TEMP_OUTPUT=$(mktemp)
            set +e  # ä¸´æ—¶å…³é—­è‡ªåŠ¨é€€å‡º
            # å°è¯•å®¡æŸ¥å·®å¼‚ï¼ˆHEAD vs é»˜è®¤åˆ†æ”¯ï¼‰
            gito --verbose review --what HEAD --against "origin/${DEFAULT_BRANCH}" 2>&1 | tee "$TEMP_OUTPUT"
            REVIEW_EXIT_CODE=${PIPESTATUS[0]}
            set -e  # æ¢å¤è‡ªåŠ¨é€€å‡º

            # åˆ¤æ–­æ˜¯å¦å› â€œæ— å˜æ›´â€è€Œå¤±è´¥
            if [ $REVIEW_EXIT_CODE -ne 0 ] || grep -q "No changes to review" "$TEMP_OUTPUT"; then
              echo "âš ï¸ No changes found or diff review failed. Falling back to full codebase review..."
              gito --verbose review --all
            else
              echo "âœ… Changes found and reviewed successfully."
            fi
            rm -f "$TEMP_OUTPUT"

          else
            # PR äº‹ä»¶ æˆ– æ‰‹åŠ¨è¿è¡Œä½†æä¾›äº† PR ç¼–å·ï¼šä½¿ç”¨é»˜è®¤ review å‘½ä»¤
            echo "ğŸŸ¢ Running in PR context or with provided PR number."
            gito --verbose review
          fi

          # æ¡ä»¶è¯„è®ºé€»è¾‘
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # æ‰‹åŠ¨è¿è¡Œï¼šåªæœ‰è¾“å…¥äº† PR ç¼–å·ä¸” comment ä¸º true æ—¶æ‰è¯„è®º
            if [ "${{ github.event.inputs.comment }}" == "true" ] && [ -n "${{ github.event.inputs.pr_number }}" ]; then
              echo "ğŸ’¬ Posting review comment to PR #${{ github.event.inputs.pr_number }}"
              gito github-comment --token ${{ secrets.GITHUB_TOKEN }}
            fi
          else
            # PR äº‹ä»¶è‡ªåŠ¨è§¦å‘ï¼šå§‹ç»ˆè¯„è®º
            echo "ğŸ’¬ Posting review comment to PR"
            gito github-comment --token ${{ secrets.GITHUB_TOKEN }}
          fi

      # ä¸Šä¼ å®¡æŸ¥æŠ¥å‘Šä½œä¸ºå·¥ä»¶
      - uses: actions/upload-artifact@v6
        with:
          name: ai-code-review-results
          path: |
            code-review-report.md
            code-review-report.json