name: "Gito: AI Code Review (DeepSeek - Forced)"

on:
  pull_request:
    types: [ opened, synchronize, reopened ]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull Request number (leave empty to review current branch)"
        required: false
      comment:
        description: "Leave a review comment on the PR (only if pr_number provided)"
        type: boolean
        default: true

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install Gito
        run: pip install gito.bot~=4.0

      # ===== ÂΩªÂ∫ïÊ∏ÖÈô§ÊâÄÊúâÂèØËÉΩÁöÑÊú¨Âú∞ÈÖçÁΩÆ =====
      - name: üî• Wipe all local Gito config files
        run: |
          rm -f .gito/config.toml
          rm -f ~/.gito/.env
          rm -f ~/.gito/config.toml  # ‰ª•Èò≤‰∏á‰∏Ä
          echo "All local configs removed."

      # ===== Âº∫Âà∂ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáèÔºàÂÜôÂÖ• $GITHUB_ENV Âíå $GITHUB_PATHÔºâ=====
      - name: üöÄ Force DeepSeek environment variables
        run: |
          # ÂÜôÂÖ• $GITHUB_ENVÔºå‰ΩøÊâÄÊúâÂêéÁª≠Ê≠•È™§ÁöÑ shell ÈÉΩËÉΩÁªßÊâø
          echo "LLM_API_KEY=${{ secrets.LLM_API_KEY }}" >> $GITHUB_ENV
          echo "OPENAI_API_KEY=${{ secrets.LLM_API_KEY }}" >> $GITHUB_ENV
          echo "LLM_API_TYPE=openai" >> $GITHUB_ENV
          echo "OPENAI_BASE_URL=https://api.deepseek.com" >> $GITHUB_ENV
          echo "OPENAI_API_BASE=https://api.deepseek.com" >> $GITHUB_ENV
          echo "MODEL=deepseek-chat" >> $GITHUB_ENV
          # ÂêåÊó∂ËÆæÁΩÆÂèØËÉΩÂΩ±ÂìçÂ∫ìË°å‰∏∫ÁöÑÁéØÂ¢ÉÂèòÈáè
          echo "OPENAI_API_TYPE=openai" >> $GITHUB_ENV
          echo "DEEPSEEK_API_KEY=${{ secrets.LLM_API_KEY }}" >> $GITHUB_ENV  # Â§áÁî®

      # ===== ÊâìÂç∞ÁéØÂ¢ÉÂèòÈáèÔºàË∞ÉËØïÔºâ=====
      - name: üîç Debug environment variables
        run: |
          echo "OPENAI_BASE_URL = $OPENAI_BASE_URL"
          echo "OPENAI_API_BASE = $OPENAI_API_BASE"
          echo "MODEL = $MODEL"
          echo "LLM_API_TYPE = $LLM_API_TYPE"
          echo "OPENAI_API_TYPE = $OPENAI_API_TYPE"
          # ÊâìÂç∞ÂØÜÈí•ÂâçÁºÄÂíåÂêéÁºÄÔºàÂÆâÂÖ®Ëµ∑ËßÅÔºâ
          KEY_PART="${OPENAI_API_KEY:0:5}...${OPENAI_API_KEY: -5}"
          echo "OPENAI_API_KEY = $KEY_PART"
          # Ê£ÄÊü•ÊòØÂê¶Â≠òÂú®ÊΩúÂú®ÂÜ≤Á™ÅÁöÑÈÖçÁΩÆÊñá‰ª∂
          echo "--- Checking for leftover config files ---"
          find ~ -name ".env" -o -name "config.toml" 2>/dev/null | grep -E "(gito|openai)" || echo "No leftover configs found."

      # ===== ‰ΩøÁî® Python ËÑöÊú¨È™åËØÅÈÖçÁΩÆÔºàÊúÄÂèØÈù†Ôºâ=====
      - name: üêç Verify OpenAI client configuration with Python
        run: |
          python -c "
  import os
  from openai import OpenAI
  
  # ÊâìÂç∞ÁéØÂ¢ÉÂèòÈáè
  print('ENV OPENAI_BASE_URL:', os.environ.get('OPENAI_BASE_URL'))
  print('ENV OPENAI_API_BASE:', os.environ.get('OPENAI_API_BASE'))
  
  # ÂàõÂª∫ÂÆ¢Êà∑Á´ØÂπ∂ÊâìÂç∞ÂÖ∂ base_url
  client = OpenAI(
  api_key=os.environ.get('OPENAI_API_KEY'),
  base_url=os.environ.get('OPENAI_BASE_URL') or os.environ.get('OPENAI_API_BASE')
  )
  print('Client base_url:', client.base_url)

# Â∞ùËØï‰∏Ä‰∏™ÁÆÄÂçïÁöÑ API Ë∞ÉÁî®ÔºàÈùûÊµÅÂºèÔºåÂè™È™åËØÅËøûÊé•Ôºâ
try:
  # ‰ªÖÁî®‰∫éÊµãËØïËøûÊé•Ôºå‰∏ç‰ºöÊ∂àËÄóÂ§ßÈáè token
  response = client.chat.completions.create(
  model=os.environ.get('MODEL', 'deepseek-chat'),
  messages=[{'role': 'user', 'content': 'Say "test"' } ],
  max_tokens=5
  )
  print('‚úÖ API connection successful!')
  print('Response:', response.choices[0].message.content)
except Exception as e:
  print('‚ùå API connection failed:', e)
  exit(1)
  "

      # ===== Ê†∏ÂøÉÂÆ°Êü•Ê≠•È™§ =====
      - name: ü§ñ Run AI code review
        env:
          # ÂÜçÊ¨°ÊòæÂºèËÆæÁΩÆÔºåÁ°Æ‰øùÂ≠êËøõÁ®ãÁªßÊâø
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_API_TYPE: openai
          OPENAI_BASE_URL: https://api.deepseek.com
          OPENAI_API_BASE: https://api.deepseek.com
          MODEL: deepseek-chat
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER_FROM_WORKFLOW_DISPATCH: ${{ github.event.inputs.pr_number }}
        run: |
          # Âà§Êñ≠ËøêË°åÊ®°Âºè
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -z "${{ github.event.inputs.pr_number }}" ]; then
            echo "üü¢ Manual run without PR number. Attempting to review changes against default branch..."
            DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"

  TEMP_OUTPUT=$(mktemp)
            set +e
            gito --verbose review --what HEAD --against "origin/${DEFAULT_BRANCH}" 2>&1 | tee "$TEMP_OUTPUT"
            REVIEW_EXIT_CODE=${PIPESTATUS[0]}
            set -e

            if [ $REVIEW_EXIT_CODE -ne 0 ] || grep -q "No changes to review" "$TEMP_OUTPUT"; then
              echo "‚ö†Ô∏è No changes found. Falling back to full codebase review..."
              gito --verbose review --all
            else
              echo "‚úÖ Changes reviewed."
            fi
            rm -f "$TEMP_OUTPUT"
          else
            echo "üü¢ Running in PR context or with provided PR number."
            gito --verbose review
          fi

          # Êù°‰ª∂ËØÑËÆ∫
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.comment }}" == "true" ] && [ -n "${{ github.event.inputs.pr_number }}" ]; then
              gito github-comment --token ${{ secrets.GITHUB_TOKEN }}
            fi
          else
            gito github-comment --token ${{ secrets.GITHUB_TOKEN }}
          fi

      # ‰∏ä‰º†Êä•Âëä
      - uses: actions/upload-artifact@v6
        with:
          name: ai-code-review-results
          path: |
            code-review-report.md
            code-review-report.json